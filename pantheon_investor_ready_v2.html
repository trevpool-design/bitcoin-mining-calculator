<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pantheon Mining Calculator - Investor Ready v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0B1C2D;
      --panel:#121E2B;
      --panel2:#162638;
      --text:#F5F7FA;
      --muted:#8A95A3;
      --line:#263647;
      --accent:#F7931A;
      --accent2:#D9822B;
      --success:#34D399;
      --warn:#FCD34D;
      --danger:#F87171;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#081521,#0B1C2D 35%,#081521);color:var(--text);min-height:100vh}

    .container{max-width:1400px;margin:0 auto;padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
    .sidebar,.main{background:rgba(17,24,39,.9);border:1px solid rgba(35,48,71,.8);border-radius:var(--radius);overflow:hidden}
    .sidebar{padding:16px;position:sticky;top:16px;height:calc(100vh - 32px);overflow-y:auto}
    .main{padding:16px}

    h1{font-size:18px;font-weight:700}
    h2{font-size:16px;font-weight:600;margin-bottom:12px}
    h3{font-size:14px;font-weight:600;margin-bottom:8px}
    h4{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}

    label{display:block;margin-top:12px;color:var(--muted);font-size:12px;font-weight:500}
    select,input[type="number"],input[type="text"],input[type="date"]{width:100%;margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(15,23,42,.7);color:var(--text);font-size:13px;outline:none}
    select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(247,147,26,.15)}
    input[readonly]{opacity:.8}

    .slider-wrap{display:grid;grid-template-columns:1fr 80px;gap:10px;align-items:center;margin-top:6px}
    input[type="range"]{-webkit-appearance:none;width:100%;height:6px;background:var(--line);border-radius:3px;outline:none}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:50%;cursor:pointer}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;border:1px solid var(--line);background:rgba(15,23,42,.7);color:var(--text);border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;user-select:none}
    .btn:hover{background:rgba(15,23,42,.95);border-color:rgba(247,147,26,.4)}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent;color:#fff;font-weight:600}
    .btn.small{padding:7px 10px;font-size:12px;border-radius:8px}
    .btn.ghost{background:transparent;border-color:transparent}
    .btn.danger{border-color:var(--danger);color:var(--danger)}

    .counter{display:grid;grid-template-columns:40px 1fr 40px;gap:8px;margin-top:6px}
    .price-row{display:grid;grid-template-columns:1fr 40px;gap:8px;margin-top:6px}

    .tabs{display:flex;gap:6px;margin-bottom:16px;border-bottom:1px solid var(--line);padding-bottom:12px;overflow-x:auto}
    .tab-btn{flex:0 0 auto;padding:10px 16px;white-space:nowrap}
    .tab-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent;color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .tile{background:rgba(15,23,42,.55);border:1px solid var(--line);border-radius:var(--radius);padding:14px;transition:all .15s}
    .tile:hover{border-color:rgba(247,147,26,.3);transform:translateY(-2px)}
    .tile p,.tile .value{font-size:20px;font-weight:700;margin:0}
    .tile .sub{font-size:12px;color:var(--muted);margin-top:4px}

    .yearly-tiles{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .yearly-tiles .tile p{font-size:14px}

    .comparison{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:stretch}
    .vs-badge{display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
    .comparison .tile.winner{border-color:var(--success);background:rgba(52,211,153,.08)}

    .chart-box{height:280px;background:rgba(15,23,42,.35);border:1px solid var(--line);border-radius:var(--radius);padding:10px}
    .chart-box canvas{width:100%!important;height:100%!important}

    .table-wrap{overflow-x:auto;border:1px solid var(--line);border-radius:var(--radius);background:rgba(15,23,42,.25)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px 8px;font-size:12px;text-align:right;border-bottom:1px solid rgba(35,48,71,.6)}
    th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:rgba(17,24,39,.98)}
    th{background:rgba(17,24,39,.95);color:var(--muted);font-weight:600;position:sticky;top:0;z-index:2}
    tr:hover td{background:rgba(247,147,26,.03)}
    tr.year-subtotal td{background:rgba(148,163,184,.08);font-weight:700}

    .divider{height:1px;background:var(--line);margin:16px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(15,23,42,.6);border:1px solid var(--line);border-radius:20px;font-size:11px;color:var(--muted)}
    .note{font-size:12px;color:var(--muted);line-height:1.5;margin-top:8px}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}

    .price-model-selector{display:flex;gap:6px;margin:10px 0}
    .price-model-btn{flex:1;padding:8px 6px;font-size:11px;text-align:center;border:1px solid var(--line);background:rgba(15,23,42,.5);border-radius:10px;color:var(--muted);cursor:pointer}
    .price-model-btn:hover{background:rgba(15,23,42,.8)}
    .price-model-btn.active{border-color:var(--accent);background:rgba(247,147,26,.12);color:var(--text)}

    .price-presets{display:flex;gap:4px;margin-bottom:10px}
    .price-preset-btn{flex:1;padding:6px 4px;font-size:10px;text-align:center;border:1px solid var(--line);background:transparent;border-radius:8px;color:var(--muted);cursor:pointer}
    .price-preset-btn:hover{background:rgba(35,48,71,.5);color:var(--text)}
    .price-preset-btn.active{border-color:var(--success);background:rgba(52,211,153,.1);color:var(--success)}

    .year-row{display:grid;grid-template-columns:50px 1fr 90px;gap:8px;align-items:center;margin-bottom:8px}
    .year-label{font-size:11px;font-weight:600;color:var(--muted)}
    .year-input{width:100%;padding:8px 10px;border:1px solid var(--line);background:rgba(15,23,42,.7);border-radius:10px;color:var(--text);font-size:13px;text-align:center}
    .year-price{font-size:12px;color:var(--text);font-weight:600;text-align:right}
    .year-price.negative{color:var(--danger)}

    .sparkline-box{height:60px;margin-top:10px;background:rgba(15,23,42,.3);border:1px solid var(--line);border-radius:10px;padding:6px}
    .sparkline-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:4px}

    .hero-metric{background:linear-gradient(135deg,rgba(15,23,42,.8),rgba(22,38,56,.6));border:1px solid var(--line);border-radius:var(--radius);padding:20px 16px;text-align:center}
    .hero-metric.highlight{border-color:rgba(247,147,26,.4);background:linear-gradient(135deg,rgba(247,147,26,.08),rgba(22,38,56,.6))}
    .hero-metric .label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
    .hero-metric .value{font-size:32px;font-weight:700;line-height:1;margin-bottom:6px}
    .hero-metric .subtext{font-size:11px;color:var(--muted)}

    .scorecard{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
    .scorecard-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(15,23,42,.5);border-radius:10px;border:1px solid var(--line)}
    .scorecard-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px}
    .scorecard-icon.pass{background:rgba(52,211,153,.15);color:var(--success)}
    .scorecard-icon.warn{background:rgba(251,191,36,.15);color:var(--warn)}
    .scorecard-icon.fail{background:rgba(248,113,113,.15);color:var(--danger)}

    .exec-timeline{display:flex;gap:6px;margin:14px 0}
    .timeline-year{flex:1;background:rgba(15,23,42,.5);border:1px solid var(--line);border-radius:10px;padding:10px 8px;text-align:center}
    .timeline-year .yr{font-size:10px;color:var(--muted);font-weight:600;margin-bottom:4px}
    .timeline-year .btc{font-size:13px;font-weight:700;margin-bottom:2px}
    .timeline-year .val{font-size:10px;color:var(--muted)}
    .timeline-year.current{border-color:rgba(247,147,26,.4);background:rgba(247,147,26,.08)}

    .grade-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:700}
    .grade-badge.excellent{background:rgba(52,211,153,.15);color:var(--success);border:1px solid rgba(52,211,153,.3)}
    .grade-badge.good{background:rgba(96,165,250,.15);color:#60A5FA;border:1px solid rgba(96,165,250,.3)}
    .grade-badge.fair{background:rgba(251,191,36,.15);color:var(--warn);border:1px solid rgba(251,191,36,.3)}
    .grade-badge.poor{background:rgba(248,113,113,.15);color:var(--danger);border:1px solid rgba(248,113,113,.3)}

    .mc-progress{height:4px;background:var(--line);border-radius:2px;margin-top:10px;overflow:hidden}
    .mc-progress-bar{height:100%;background:var(--accent);transition:width .1s;width:0}

    .sticky-actions{position:sticky;bottom:0;padding:12px 0 0;background:linear-gradient(180deg,transparent,rgba(17,24,39,.98) 30%)}
    #advancedAssumptions.collapsed{display:none}

    @media(max-width:1024px){.container{grid-template-columns:1fr}.sidebar{position:relative;height:auto}.tiles,.scorecard{grid-template-columns:1fr 1fr}.yearly-tiles{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.tiles,.scorecard{grid-template-columns:1fr}.yearly-tiles{grid-template-columns:1fr 1fr}.comparison{grid-template-columns:1fr}.vs-badge{display:none}.exec-timeline{flex-wrap:wrap}.timeline-year{flex:1 1 45%}}
  </style>
</head>
<body>

<div class="container">
  <aside class="sidebar">
    <div class="row" style="margin-bottom:12px">
      <div><h1>Pantheon Mining</h1><div class="pill">v2.0 Investor Ready</div></div>
      <button class="btn small danger" id="resetBtn">Reset</button>
    </div>

    <label>Project</label>
    <select id="project"><option>UAE: Operation SandHash 2</option></select>

    <label>Mining Hardware</label>
    <select id="minerModel">
      <option value="s21hyd" data-hash="335" data-power="5.36" data-capex="9600">Antminer S21 Hyd 335 TH/s</option>
      <option value="s21pro" data-hash="234" data-power="3.5" data-capex="5500">Antminer S21 Pro 234 TH/s</option>
      <option value="s19pro" data-hash="110" data-power="3.25" data-capex="1600">Antminer S19 Pro 110 TH/s</option>
    </select>

    <label>Display Currency</label>
    <select id="currency"><option value="USD">USD ($)</option><option value="EUR">EUR (‚Ç¨)</option></select>

    <label>USD ‚Üí EUR Rate</label>
    <div class="price-row">
      <input type="number" id="fxRate" value="0.92" step="0.001" min="0">
      <button class="btn small" id="refreshFx">‚Üª</button>
    </div>

    <label>Number of Miners</label>
    <div class="counter">
      <button class="btn" id="minerMinus">‚àí</button>
      <input type="number" id="minerCount" value="138" min="1" step="1">
      <button class="btn" id="minerPlus">+</button>
    </div>
    <div class="note" id="capexDisplay">Hardware Capex: $1,324,800</div>

    <label>Investment Horizon</label>
    <div class="slider-wrap">
      <input type="range" id="holdMonthsRange" min="12" max="120" step="1" value="60">
      <input type="number" id="holdMonths" min="12" max="120" step="1" value="60">
    </div>

    <label>Current BTC Price</label>
    <div class="price-row">
      <input type="text" id="currentBtcPrice" readonly placeholder="Loading...">
      <button class="btn small" id="refreshPrice">‚Üª</button>
    </div>

    <label>Manual Price Override (USD)</label>
    <input type="number" id="btcOverride" placeholder="e.g. 105000" step="100" min="0">

    <!-- Custom Price Projections Panel -->
    <div class="tile" style="margin-top:14px;padding:12px">
      <h4 style="margin-bottom:10px">Price Projections (5-Year)</h4>
      <div class="price-model-selector">
        <button class="price-model-btn" data-mode="cycle">Cycle Model</button>
        <button class="price-model-btn active" data-mode="custom">Custom Annual</button>
      </div>

      <div id="cycleModelNote" class="note" style="display:none">
        Price follows cycle model with <strong id="cycleDetails">20% drift, ¬±60% amplitude</strong>
      </div>

      <div id="customPriceControls">
        <div class="price-presets">
          <button class="price-preset-btn" data-preset="bull">Bull</button>
          <button class="price-preset-btn" data-preset="base">Base</button>
          <button class="price-preset-btn" data-preset="bear">Bear</button>
          <button class="price-preset-btn active" data-preset="custom">Custom</button>
        </div>
        <div class="year-row" style="margin-bottom:4px">
          <span style="font-size:10px;color:var(--muted)">Year</span>
          <span style="font-size:10px;color:var(--muted);text-align:center">Change %</span>
          <span style="font-size:10px;color:var(--muted);text-align:right">Price</span>
        </div>
        <div class="year-row"><span class="year-label">Year 1</span><input type="number" class="year-input" id="priceY1" value="200" min="-90" max="500" step="1"><span class="year-price" id="priceY1Display">$0</span></div>
        <div class="year-row"><span class="year-label">Year 2</span><input type="number" class="year-input" id="priceY2" value="80" min="-90" max="500" step="1"><span class="year-price" id="priceY2Display">$0</span></div>
        <div class="year-row"><span class="year-label">Year 3</span><input type="number" class="year-input" id="priceY3" value="5" min="-90" max="500" step="1"><span class="year-price" id="priceY3Display">$0</span></div>
        <div class="year-row"><span class="year-label">Year 4</span><input type="number" class="year-input" id="priceY4" value="-60" min="-90" max="500" step="1"><span class="year-price" id="priceY4Display">$0</span></div>
        <div class="year-row"><span class="year-label">Year 5</span><input type="number" class="year-input" id="priceY5" value="25" min="-90" max="500" step="1"><span class="year-price" id="priceY5Display">$0</span></div>
        <div class="sparkline-box"><canvas id="priceSparkline"></canvas></div>
        <div class="sparkline-labels"><span>Start</span><span>Year 5</span></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <h3 style="margin:0">Advanced Assumptions</h3>
      <button class="btn small ghost" id="toggleAdvanced">Show</button>
    </div>

    <div id="advancedAssumptions" class="collapsed">
      <label>BTC Price Drift (%/yr)</label>
      <div class="slider-wrap"><input type="range" id="priceDriftRange" min="-20" max="60" step="1" value="20"><input type="number" id="priceDrift" value="20" step="1"></div>

      <label>BTC Cycle Amplitude (¬±%)</label>
      <div class="slider-wrap"><input type="range" id="priceCycleAmpRange" min="0" max="150" step="1" value="60"><input type="number" id="priceCycleAmp" value="60" step="1"></div>

      <label>Cycle Length (months)</label>
      <div class="slider-wrap"><input type="range" id="priceCycleMonthsRange" min="24" max="72" step="1" value="48"><input type="number" id="priceCycleMonths" value="48" step="1"></div>

      <label>Halving Anchor Date</label>
      <input type="date" id="halvingAnchor" value="2024-04-20">

      <label>Unit Miner Cost ($)</label>
      <div class="slider-wrap"><input type="range" id="unitCapexRange" min="500" max="15000" step="100" value="9600"><input type="number" id="unitCapex" value="9600" step="100"></div>

      <label>Power Cost ($/kWh)</label>
      <div class="slider-wrap"><input type="range" id="powerCostRange" min="0" max="0.15" step="0.001" value="0.05"><input type="number" id="powerCost" value="0.05" step="0.001"></div>

      <label>Hashrate per Miner (TH/s)</label>
      <div class="slider-wrap"><input type="range" id="hashratePerMinerRange" min="50" max="500" step="1" value="335"><input type="number" id="hashratePerMiner" value="335" step="1"></div>

      <label>Power per Miner (kW)</label>
      <div class="slider-wrap"><input type="range" id="powerPerMinerRange" min="1" max="10" step="0.01" value="5.36"><input type="number" id="powerPerMiner" value="5.36" step="0.01"></div>

      <label>Network Hashrate (EH/s)</label>
      <div class="slider-wrap"><input type="range" id="networkHashrateEHRange" min="400" max="2000" step="10" value="850"><input type="number" id="networkHashrateEH" value="850" step="10"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <button class="btn small" id="fetchHashrateBtn" title="Fetch live network hashrate">‚ü≥ Fetch Live</button>
        <span id="hashrateStatus" class="muted" style="font-size:11px"></span>
      </div>

      <label>Uptime (%)</label>
      <div class="slider-wrap"><input type="range" id="uptimeRange" min="80" max="100" step="0.5" value="97"><input type="number" id="uptime" value="97" step="0.5"></div>

      <label>Pool Fee (%)</label>
      <div class="slider-wrap"><input type="range" id="poolFeeRange" min="0" max="5" step="0.1" value="1.5"><input type="number" id="poolFee" value="1.5" step="0.1"></div>

      <label>Hosting Fee (% of revenue)</label>
      <div class="slider-wrap"><input type="range" id="hostingFeeRange" min="0" max="10" step="0.1" value="0"><input type="number" id="hostingFee" value="0" step="0.1"></div>

      <label>Management Fee (% of revenue)</label>
      <div class="slider-wrap"><input type="range" id="managementFeeRange" min="0" max="10" step="0.1" value="0"><input type="number" id="managementFee" value="0" step="0.1"></div>

      <label>Insurance (% of revenue)</label>
      <div class="slider-wrap"><input type="range" id="insuranceFeeRange" min="0" max="5" step="0.1" value="0"><input type="number" id="insuranceFee" value="0" step="0.1"></div>

      <label>Repair Reserve (% of capex/yr)</label>
      <div class="slider-wrap"><input type="range" id="repairReserveRange" min="0" max="5" step="0.1" value="2"><input type="number" id="repairReserve" value="2" step="0.1"></div>

      <label>ASIC Degradation (%/yr)</label>
      <div class="slider-wrap"><input type="range" id="degradationRange" min="0" max="20" step="0.5" value="2"><input type="number" id="degradation" value="2" step="0.5"></div>

      <label>Difficulty Growth (%/yr)</label>
      <div class="slider-wrap"><input type="range" id="difficultyGrowthRange" min="-10" max="50" step="0.5" value="20"><input type="number" id="difficultyGrowth" value="20" step="0.5"></div>

      <label>Resale Value (% of capex)</label>
      <div class="slider-wrap"><input type="range" id="resaleRange" min="0" max="50" step="1" value="0"><input type="number" id="resaleValue" value="0" step="1"></div>

      <label style="margin-top:16px"><input type="checkbox" id="reinvestBtc" style="width:auto;margin-right:8px">Sell BTC to cover operating costs</label>
    </div>

    <div class="sticky-actions">
      <div class="row">
        <button class="btn primary" id="shareBtn">Share</button>
        <button class="btn" id="exportBtn">CSV</button>
        <button class="btn" id="exportHtmlBtn">Report</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="tabs">
      <button class="btn tab-btn active" data-tab="executive">Executive</button>
      <button class="btn tab-btn" data-tab="overview">Overview</button>
      <button class="btn tab-btn" data-tab="dashboard">Dashboard</button>
      <button class="btn tab-btn" data-tab="cashflow">Cash Flow</button>
      <button class="btn tab-btn" data-tab="sensitivity">Sensitivity</button>
      <button class="btn tab-btn" data-tab="montecarlo">Monte Carlo</button>
    </div>

    <!-- EXECUTIVE TAB -->
    <section id="executive" class="tab-content active">
      <div class="row" style="margin-bottom:16px;justify-content:space-between">
        <h2 style="margin:0">Investment Summary</h2>
        <div id="investmentGrade" class="grade-badge excellent">Excellent</div>
      </div>

      <div class="tiles">
        <div class="hero-metric highlight">
          <div class="label">Return Multiple</div>
          <div class="value" id="heroMoic" style="color:var(--accent)">‚Äîx</div>
          <div class="subtext">MOIC (BTC only)</div>
        </div>
        <div class="hero-metric">
          <div class="label">Annualized Return</div>
          <div class="value" id="heroIrr">‚Äî%</div>
          <div class="subtext">IRR (pre-tax)</div>
        </div>
        <div class="hero-metric">
          <div class="label">Capital Recovery</div>
          <div class="value" id="heroPayback">‚Äî</div>
          <div class="subtext">months to payback</div>
        </div>
      </div>

      <h3>Investment Scorecard</h3>
      <div class="scorecard">
        <div class="scorecard-item"><div class="scorecard-icon pass" id="scoreMoicIcon">‚úì</div><div><div class="muted" style="font-size:11px">Return Multiple</div><div id="scoreMoicText">‚Äî</div></div></div>
        <div class="scorecard-item"><div class="scorecard-icon pass" id="scorePaybackIcon">‚úì</div><div><div class="muted" style="font-size:11px">Payback Period</div><div id="scorePaybackText">‚Äî</div></div></div>
        <div class="scorecard-item"><div class="scorecard-icon pass" id="scoreCostIcon">‚úì</div><div><div class="muted" style="font-size:11px">Production Cost</div><div id="scoreCostText">‚Äî</div></div></div>
        <div class="scorecard-item"><div class="scorecard-icon pass" id="scoreEdgeIcon">‚úì</div><div><div class="muted" style="font-size:11px">Mining Advantage</div><div id="scoreEdgeText">‚Äî</div></div></div>
      </div>

      <h3>Mining vs Buying Bitcoin</h3>
      <div class="compare-toggle" style="display:flex;gap:6px;margin-bottom:12px">
        <button class="btn small compare-mode-btn active" data-mode="cashMatched">Cash-Matched Buy</button>
        <button class="btn small compare-mode-btn" data-mode="dca">True DCA</button>
      </div>
      <div class="note" id="compareModeNote" style="margin-bottom:12px;font-size:11px">Same timing as mining: capex upfront, OPEX at each month's price.</div>
      <div class="comparison">
        <div class="tile" id="miningCard"><h4>‚õèÔ∏è Mining</h4><p id="execMiningBtc">0.0000</p><div class="sub">BTC acquired</div><div class="sub" id="execMiningValue">$0</div></div>
        <div class="vs-badge">VS</div>
        <div class="tile" id="buyingCard"><h4 id="buyingCardTitle">üíµ Cash-Matched Buy</h4><p id="execBuyBtc">0.0000</p><div class="sub">BTC acquired</div><div class="sub" id="execBuyValue">$0</div></div>
      </div>

      <div class="tile" style="margin-top:16px;text-align:center" id="advantageCard">
        <h4>Mining Advantage</h4>
        <p id="execAdvValue" style="color:var(--success)">+0.0000 BTC</p>
        <div class="sub" id="execAdvDetail">‚Äî</div>
      </div>

      <h3 style="margin-top:16px">5-Year BTC Accumulation</h3>
      <div class="exec-timeline" id="execTimeline"></div>

      <h3 style="margin-top:16px">Cumulative Net Value</h3>
      <div class="chart-box"><canvas id="execChart"></canvas></div>

      <div class="tile" style="margin-top:16px">
        <h4>Key Assumptions</h4>
        <div id="execAssumptions" class="note">‚Äî</div>
      </div>
    </section>

    <!-- OVERVIEW TAB -->
    <section id="overview" class="tab-content">
      <h2>Detailed Outputs</h2>
      <div class="tiles">
        <div class="tile"><h4>Cumulative Revenue</h4><p id="ovRevenue">$0</p></div>
        <div class="tile"><h4>Cumulative Costs</h4><p id="ovCosts">$0</p></div>
        <div class="tile"><h4>Net Cash Flow</h4><p id="ovNetCash">$0</p></div>
      </div>
      <div class="tiles">
        <div class="tile"><h4>IRR (with Resale)</h4><p id="ovIrr">0%</p></div>
        <div class="tile"><h4>MOIC (with Resale)</h4><p id="ovMoic">0x</p></div>
        <div class="tile"><h4>Ending BTC</h4><p id="ovBtcMined">0</p></div>
      </div>

      <h3 style="margin-top:16px">Profitability Over Time</h3>
      <div class="chart-box"><canvas id="profitabilityChart"></canvas></div>

      <div class="divider"></div>

      <h3>Yearly BTC Value</h3>
      <div class="yearly-tiles" id="yearlyTiles"></div>

      <div class="divider"></div>

      <h3>Mining vs Buying Comparison</h3>
      <div class="note" id="ovCompareModeNote" style="margin-bottom:12px">Cash-Matched Buy: Same timing as mining (capex upfront, OPEX at each month's price).</div>
      <div class="comparison">
        <div class="tile" id="ovMiningCard"><h4>Mining</h4><p id="ovMiningBtc">0.0000</p><div class="sub">BTC accumulated</div><div class="sub" id="ovMiningValue">$0</div></div>
        <div class="vs-badge">VS</div>
        <div class="tile" id="ovBuyingCard"><h4 id="ovBuyingCardTitle">Cash-Matched Buy</h4><p id="ovBuyBtc">0.0000</p><div class="sub">BTC accumulated</div><div class="sub" id="ovBuyValue">$0</div></div>
      </div>

      <div class="tile" style="margin-top:16px">
        <h4>Cost Analysis</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px">
          <div><div class="muted" style="font-size:11px">Avg Cost per BTC</div><div style="font-size:18px;font-weight:700" id="ovCostPerBtc">$0</div></div>
          <div><div class="muted" style="font-size:11px">Current Market Price</div><div style="font-size:18px;font-weight:700" id="ovMarketPrice">$0</div></div>
          <div><div class="muted" style="font-size:11px">Production Margin</div><div style="font-size:18px;font-weight:700" id="ovMargin">0%</div></div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD TAB -->
    <section id="dashboard" class="tab-content">
      <div class="row" style="margin-bottom:16px;justify-content:space-between">
        <div><h2 style="margin:0">Live Mining Dashboard</h2><div class="note" style="margin:0">Real-time view of your mining operation</div></div>
        <div class="pill" style="background:rgba(52,211,153,.15);color:var(--success);border-color:var(--success)">‚óè Operations Active</div>
      </div>
      <div class="tiles" style="grid-template-columns:repeat(4,1fr)">
        <div class="tile"><h4>Total BTC Mined</h4><p id="dashBtcMined">0.000</p><div class="sub" id="dashBtcChange">‚Äî</div></div>
        <div class="tile"><h4>Portfolio Value</h4><p id="dashPortfolioValue">$0</p><div class="sub" id="dashPortfolioChange">‚Äî</div></div>
        <div class="tile"><h4>Fleet Hashrate</h4><p id="dashHashrate">0 TH/s</p><div class="sub" id="dashUptimeStatus">‚Äî</div></div>
        <div class="tile"><h4>Cost per BTC</h4><p id="dashCostPerBtc">$0</p><div class="sub" id="dashCostMargin">‚Äî</div></div>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:16px">
        <div>
          <h3 style="margin-bottom:8px">BTC Accumulation Progress</h3>
          <div class="chart-box"><canvas id="dashAccumChart"></canvas></div>
        </div>
        <div>
          <div class="tile" style="margin-bottom:12px">
            <h4>BREAK-EVEN PROGRESS</h4>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px">
              <span class="muted" style="font-size:12px">Progress</span>
              <span id="dashBreakevenPct" style="font-size:12px">0%</span>
            </div>
            <div style="background:var(--line);border-radius:4px;height:10px;overflow:hidden">
              <div id="dashBreakevenBar" style="height:100%;background:var(--success);width:0%;transition:width .3s"></div>
            </div>
            <div id="dashBreakevenRemaining" class="sub" style="margin-top:6px">Estimated ‚Äî months remaining</div>
          </div>
          <div class="tile">
            <h4>PERIOD STATISTICS</h4>
            <div style="display:flex;justify-content:space-between;margin-top:8px"><span class="muted">Gross BTC Mined</span><span id="dashGrossBtc">0.0000</span></div>
            <div style="display:flex;justify-content:space-between;margin-top:4px"><span class="muted">Pool Fees</span><span id="dashPoolFees" style="color:var(--danger)">-0.0000</span></div>
            <div style="display:flex;justify-content:space-between;margin-top:4px"><span class="muted">Net BTC</span><span id="dashNetBtc">0.0000</span></div>
            <div style="border-top:1px solid var(--line);margin:8px 0"></div>
            <div style="display:flex;justify-content:space-between"><span class="muted">Power Costs</span><span id="dashPowerCosts">$0</span></div>
            <div style="display:flex;justify-content:space-between;margin-top:4px"><span class="muted">Operating Fees</span><span id="dashOpFees">$0</span></div>
            <div style="display:flex;justify-content:space-between;margin-top:4px"><span class="muted">Net Income</span><span id="dashNetIncome" style="font-weight:600">$0</span></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:16px">
        <div>
          <h3 style="margin-bottom:8px">Monthly Revenue vs Costs</h3>
          <div class="chart-box"><canvas id="dashRevenueChart"></canvas></div>
        </div>
        <div class="tile">
          <h4>RECENT ACTIVITY</h4>
          <div id="dashActivity" style="margin-top:8px">
            <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--line)">
              <div style="width:32px;height:32px;border-radius:8px;background:rgba(247,147,26,.15);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700">B</div>
              <div><div style="font-weight:500">Block reward received</div><div class="sub" id="dashActivityBlock">+0.00234 BTC ‚Ä¢ 2 hours ago</div></div>
            </div>
            <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--line)">
              <div style="width:32px;height:32px;border-radius:8px;background:rgba(251,191,36,.15);display:flex;align-items:center;justify-content:center;color:var(--warn)">‚ö°</div>
              <div><div style="font-weight:500">Power bill settled</div><div class="sub" id="dashActivityPower">-$4,521 ‚Ä¢ Yesterday</div></div>
            </div>
            <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0">
              <div style="width:32px;height:32px;border-radius:8px;background:rgba(96,165,250,.15);display:flex;align-items:center;justify-content:center;color:#60A5FA">‚ó´</div>
              <div><div style="font-weight:500">Difficulty adjustment</div><div class="sub" id="dashActivityDiff">+2.1% increase ‚Ä¢ 3 days ago</div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="tiles" style="grid-template-columns:repeat(4,1fr);margin-top:16px">
        <div class="tile"><h4>PROJECTED YEAR-END BTC</h4><p id="dashYearEndBtc">0.000</p><div class="sub">at current production rate</div></div>
        <div class="tile"><h4>PROJECTED YEAR-END VALUE</h4><p id="dashYearEndValue">$0</p><div class="sub">based on scenario price</div></div>
        <div class="tile"><h4>EFFECTIVE HASH SHARE</h4><p id="dashHashShare">0%</p><div class="sub">of network hashrate</div></div>
        <div class="tile"><h4>POWER EFFICIENCY</h4><p id="dashEfficiency">0 J/TH</p><div class="sub">fleet average</div></div>
      </div>
    </section>

    <!-- CASH FLOW TAB -->
    <section id="cashflow" class="tab-content">
      <div class="row" style="margin-bottom:16px;justify-content:space-between">
        <h2 style="margin:0">Cash Flow Bridge</h2>
        <button class="btn small" id="toggleCashflowView">Switch to Annual</button>
      </div>
      <div class="table-wrap" style="max-height:600px;overflow:auto">
        <table id="cashflowTable">
          <thead><tr><th>Period</th><th>Gross BTC</th><th>Pool Fee</th><th>Net BTC</th><th>BTC Price</th><th>Revenue</th><th>Power</th><th>Hosting</th><th>Mgmt</th><th>Insurance</th><th>Repairs</th><th>Net Cash</th><th>Cumulative</th></tr></thead>
          <tbody id="cashflowBody"></tbody>
        </table>
      </div>
    </section>

    <!-- SENSITIVITY TAB -->
    <section id="sensitivity" class="tab-content">
      <h2>Sensitivity Analysis</h2>
      <div class="note" style="margin-bottom:16px">How MOIC changes with different BTC price and difficulty assumptions. Current settings highlighted.</div>
      <div class="table-wrap">
        <table id="sensitivityTable">
          <thead><tr><th>BTC Price</th><th>Diff +5%/yr</th><th>Diff +15%/yr</th><th>Diff +25%/yr</th><th>Diff +35%/yr</th></tr></thead>
          <tbody id="sensitivityBody"></tbody>
        </table>
      </div>
      <div class="divider"></div>
      <h3>Power Cost Sensitivity</h3>
      <div class="note" style="margin-bottom:10px">Total MOIC includes BTC value plus net cash position (revenue minus operating costs).</div>
      <div class="table-wrap">
        <table id="powerSensitivityTable">
          <thead><tr><th>Power ($/kWh)</th><th>Total MOIC</th><th>Monthly OPEX</th><th>Breakeven BTC</th></tr></thead>
          <tbody id="powerSensitivityBody"></tbody>
        </table>
      </div>
    </section>

    <!-- MONTE CARLO TAB -->
    <section id="montecarlo" class="tab-content">
      <h2>Monte Carlo Simulation</h2>
      <div class="note" style="margin-bottom:16px">1,000 randomized scenarios varying price trajectory, difficulty growth, and network conditions.</div>
      <div class="tiles">
        <div class="tile"><h4>Prob. MOIC > 1.5x</h4><p id="mcProbMoic">‚Äî%</p></div>
        <div class="tile"><h4>Prob. Breakeven < 18mo</h4><p id="mcProbBreakeven">‚Äî%</p></div>
        <div class="tile"><h4>Avg. Ending BTC</h4><p id="mcAvgBtc">‚Äî</p></div>
      </div>
      <div class="chart-box"><canvas id="mcChart"></canvas></div>
      <div class="mc-progress" id="mcProgress" style="display:none"><div class="mc-progress-bar" id="mcProgressBar"></div></div>
      <button class="btn primary" id="rerunMC" style="margin-top:12px">Re-run Monte Carlo</button>
    </section>
  </main>
</div>

<script>
const CONFIG = { BLOCK_REWARD: 3.125, BLOCKS_PER_DAY: 144, NEXT_HALVING_MONTH: 28 };

const DEFAULTS = {
  minerModel: "s21hyd", currency: "USD", fxRate: 0.92, minerCount: 138, holdMonths: 60,
  scenario: "base", btcOverride: "", priceModel: "custom", pricePreset: "custom",
  priceY1: 200, priceY2: 80, priceY3: 5, priceY4: -60, priceY5: 25,
  priceDrift: 20, priceCycleAmp: 60, priceCycleMonths: 48, halvingAnchor: "2024-04-20",
  unitCapex: 9600, powerCost: 0.05, hashratePerMiner: 335, powerPerMiner: 5.36,
  networkHashrateEH: 850, uptime: 97, poolFee: 1.5, hostingFee: 0, managementFee: 0,
  insuranceFee: 0, repairReserve: 2, degradation: 2, difficultyGrowth: 20,
  resaleValue: 0, reinvestBtc: false, cashflowView: "monthly", compareMode: "cashMatched"
};

const SCENARIOS = { bear: { drift: 5, amp: 45 }, base: { drift: 20, amp: 60 }, bull: { drift: 35, amp: 80 } };
const PRESETS = { bull: { y1: 40, y2: 30, y3: 25, y4: 20, y5: 15 }, base: { y1: 15, y2: 10, y3: 8, y4: 5, y5: 5 }, bear: { y1: -10, y2: -5, y3: 0, y4: 5, y5: 10 } };

let state = JSON.parse(JSON.stringify(DEFAULTS));
let btcSpotUSD = 100000;
let modelCache = { key: null, result: null };
let charts = {};

const $ = id => document.getElementById(id);
const clamp = (x, lo, hi) => Math.min(hi, Math.max(lo, x));
const fmtMoney = x => Math.round(x || 0).toLocaleString();
const fmtBtc = (x, d = 4) => (x || 0).toFixed(d);
const fmtPct = (x, d = 1) => ((x || 0) * 100).toFixed(d) + '%';
const fmtNum = (x, d = 2) => (x || 0).toFixed(d);
const symbolFor = cur => cur === 'EUR' ? '‚Ç¨' : '$';
const toDisplay = usd => state.currency === 'EUR' ? usd * (state.fxRate || 0.92) : usd;
const debounce = (fn, ms = 100) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

function getBtcPrice() { return state.btcOverride ? +state.btcOverride : btcSpotUSD; }

function getPrices(months) {
  const p0 = getBtcPrice();
  const prices = [p0];
  if (state.priceModel === 'custom') {
    const changes = [state.priceY1/100, state.priceY2/100, state.priceY3/100, state.priceY4/100, state.priceY5/100];
    for (let m = 1; m <= months; m++) {
      const yr = Math.floor((m - 1) / 12);
      const monthInYr = (m - 1) % 12;
      const yStart = yr === 0 ? p0 : prices[yr * 12];
      const yEnd = yStart * (1 + (changes[yr] || changes[4]));
      prices[m] = yStart + (yEnd - yStart) * (monthInYr + 1) / 12;
    }
  } else {
    const scen = SCENARIOS[state.scenario] || SCENARIOS.base;
    const drift = (state.priceDrift ?? scen.drift) / 100;
    const amp = (state.priceCycleAmp ?? scen.amp) / 100;
    const cycleLen = state.priceCycleMonths || 48;
    const halvingDate = new Date(state.halvingAnchor || '2024-04-20');
    const now = new Date();
    const monthsSinceHalving = (now.getFullYear() - halvingDate.getFullYear()) * 12 + (now.getMonth() - halvingDate.getMonth());
    for (let m = 1; m <= months; m++) {
      const phase = ((monthsSinceHalving + m) / cycleLen) * 2 * Math.PI;
      const trend = Math.pow(1 + drift, m / 12);
      const cycle = 1 + amp * Math.sin(phase);
      prices[m] = Math.max(100, p0 * trend * cycle);
    }
  }
  return prices;
}

function model(overrides = {}) {
  const s = { ...state, ...overrides };
  const key = JSON.stringify(s);
  if (!overrides || Object.keys(overrides).length === 0) {
    if (modelCache.key === key) return modelCache.result;
  }

  const prices = getPrices(s.holdMonths);
  const capex = s.minerCount * s.unitCapex;
  const fleetHashTH = s.minerCount * s.hashratePerMiner;
  const fleetPowerKW = s.minerCount * s.powerPerMiner;
  const networkHashTH = s.networkHashrateEH * 1e6;

  const rows = [];
  let cumBtcGross = 0, cumBtcNet = 0, cumRevenue = 0, cumOpex = 0, btcHeld = 0, paybackMonth = null;

  for (let m = 1; m <= s.holdMonths; m++) {
    const price = prices[m];
    let reward = CONFIG.BLOCK_REWARD;
    if (m > CONFIG.NEXT_HALVING_MONTH) reward /= 2;
    if (m > CONFIG.NEXT_HALVING_MONTH + 48) reward /= 2;

    const yearFrac = (m - 1) / 12;
    const degradeFactor = Math.pow(1 - s.degradation / 100, yearFrac);
    const diffFactor = Math.pow(1 + s.difficultyGrowth / 100, yearFrac);
    const effectiveHash = fleetHashTH * degradeFactor * (s.uptime / 100);
    const networkAdj = networkHashTH * diffFactor;

    const dailyBtc = (effectiveHash / networkAdj) * CONFIG.BLOCKS_PER_DAY * reward;
    const grossBtc = dailyBtc * 30;
    const poolFeeBtc = grossBtc * (s.poolFee / 100);
    const netBtc = grossBtc - poolFeeBtc;

    cumBtcGross += grossBtc;
    cumBtcNet += netBtc;

    const revenue = netBtc * price;
    const powerCost = fleetPowerKW * 24 * 30 * s.powerCost;
    const hostingCost = revenue * (s.hostingFee / 100);
    const mgmtCost = revenue * (s.managementFee / 100);
    const insuranceCost = revenue * (s.insuranceFee / 100);
    const repairCost = (capex * (s.repairReserve / 100)) / 12;
    const totalOpex = powerCost + hostingCost + mgmtCost + insuranceCost + repairCost;

    cumRevenue += revenue;
    cumOpex += totalOpex;

    let netCash = revenue - totalOpex;
    if (s.reinvestBtc && netCash < 0) {
      const btcSold = Math.min(netBtc, Math.abs(netCash) / price);
      btcHeld += netBtc - btcSold;
    } else {
      btcHeld += netBtc;
    }

    const portfolioValue = btcHeld * price;
    const cumNetValue = portfolioValue - capex - (s.reinvestBtc ? 0 : cumOpex);
    if (paybackMonth === null && cumNetValue >= 0) paybackMonth = m;

    rows.push({ month: m, price, grossBtc, poolFeeBtc, netBtc, revenue, powerCost, hostingCost, mgmtCost, insuranceCost, repairCost, totalOpex, netCash, btcHeld, cumNetValue });
  }

  const last = rows[rows.length - 1];
  const endingBtc = last.btcHeld;
  const endingPrice = last.price;
  const endingValue = endingBtc * endingPrice;
  const resaleAmount = capex * (s.resaleValue / 100);
  const moicNoResale = capex > 0 ? endingValue / capex : 0;
  const moic = capex > 0 ? (endingValue + resaleAmount) / capex : 0;

  const cf = [-capex];
  for (let i = 0; i < rows.length - 1; i++) cf.push(s.reinvestBtc ? 0 : -rows[i].totalOpex);
  cf.push(endingValue + resaleAmount + (s.reinvestBtc ? 0 : -rows[rows.length - 1].totalOpex));
  const irrM = calcIRR(cf);
  const irrA = irrM !== null ? Math.pow(1 + irrM, 12) - 1 : null;

  const cfNoResale = [...cf];
  cfNoResale[cfNoResale.length - 1] -= resaleAmount;
  const irrMNoResale = calcIRR(cfNoResale);
  const irrANoResale = irrMNoResale !== null ? Math.pow(1 + irrMNoResale, 12) - 1 : null;

  // Cash-Matched Buy: Same timing as mining (capex upfront, OPEX at each month's price)
  let cashMatchedBtc = prices[0] > 0 ? capex / prices[0] : 0;
  if (!s.reinvestBtc) {
    for (const r of rows) {
      if (r.price > 0) cashMatchedBtc += r.totalOpex / r.price;
    }
  }
  const cashMatchedValue = cashMatchedBtc * endingPrice;

  // True DCA: Total cash spread evenly across all months
  const totalCash = capex + cumOpex;
  const monthlyDca = totalCash / rows.length;
  let trueDcaBtc = 0;
  for (const r of rows) {
    if (r.price > 0) trueDcaBtc += monthlyDca / r.price;
  }
  const trueDcaValue = trueDcaBtc * endingPrice;

  const totalCosts = capex + cumOpex;
  const costPerBtc = cumBtcNet > 0 ? totalCosts / cumBtcNet : 0;

  const yearlyData = [];
  for (let y = 1; y <= 5; y++) {
    const idx = Math.min(y * 12, rows.length) - 1;
    if (idx >= 0) yearlyData.push({ year: y, btc: rows[idx].btcHeld, price: rows[idx].price, value: rows[idx].btcHeld * rows[idx].price });
  }

  const result = { rows, prices, capex, fleetHashTH, fleetPowerKW, endingBtc, endingPrice, endingValue, resaleAmount, moic, moicNoResale, irrA, irrANoResale, paybackMonth, cumBtcGross, cumBtcNet, cumRevenue, cumOpex, cashMatchedBtc, cashMatchedValue, trueDcaBtc, trueDcaValue, costPerBtc, yearlyData };

  if (!overrides || Object.keys(overrides).length === 0) modelCache = { key, result };
  return result;
}

function calcIRR(cf) {
  let hasNeg = false, hasPos = false;
  for (const c of cf) { if (c < 0) hasNeg = true; if (c > 0) hasPos = true; }
  if (!hasNeg || !hasPos) return null;
  const npv = r => cf.reduce((a, c, i) => a + c / Math.pow(1 + r, i), 0);
  let lo = -0.99, hi = 2;
  for (let i = 0; i < 80; i++) { const m = (lo + hi) / 2; if (npv(m) > 0) lo = m; else hi = m; }
  return (lo + hi) / 2;
}

function modelWith(adj) {
  const saved = JSON.parse(JSON.stringify(state));
  Object.assign(state, adj);
  const out = model();
  state = saved;
  return out;
}

function updateAll() {
  const out = model();
  const sym = symbolFor(state.currency);

  // Capex
  $('capexDisplay').textContent = `Hardware Capex: ${sym}${fmtMoney(toDisplay(out.capex))}`;

  // Executive
  $('heroMoic').textContent = fmtNum(out.moicNoResale, 2) + 'x';
  $('heroIrr').textContent = out.irrANoResale !== null ? fmtPct(out.irrANoResale, 1) : 'N/A';
  $('heroPayback').textContent = out.paybackMonth || '>60';

  updateScorecard(out);
  updateExecutiveComparison(out, sym);
  updateTimeline(out, sym);
  updateOverview(out, sym);
  updateDashboard(out, sym);
  updateCashflow(out, sym);
  updateCharts(out);
  updatePriceDisplays();
}

function updateScorecard(out) {
  const moic = out.moicNoResale;
  let mClass = moic >= 2 ? 'pass' : moic >= 1.5 ? 'pass' : moic >= 1 ? 'warn' : 'fail';
  $('scoreMoicIcon').className = `scorecard-icon ${mClass}`;
  $('scoreMoicIcon').textContent = mClass === 'pass' ? '‚úì' : mClass === 'warn' ? '!' : '‚úó';
  $('scoreMoicText').textContent = moic >= 2 ? `Excellent (${fmtNum(moic)}x)` : moic >= 1.5 ? `Good (${fmtNum(moic)}x)` : moic >= 1 ? `Moderate (${fmtNum(moic)}x)` : `Below target (${fmtNum(moic)}x)`;

  const pb = out.paybackMonth || 999;
  let pClass = pb <= 24 ? 'pass' : pb <= 36 ? 'warn' : 'fail';
  $('scorePaybackIcon').className = `scorecard-icon ${pClass}`;
  $('scorePaybackIcon').textContent = pClass === 'pass' ? '‚úì' : pClass === 'warn' ? '!' : '‚úó';
  $('scorePaybackText').textContent = pb <= 24 ? `Within 24 mo (${pb})` : pb <= 36 ? `Extended (${pb} mo)` : pb < 999 ? `Long (${pb} mo)` : 'Not achieved';

  const costRatio = out.costPerBtc / getBtcPrice();
  let cClass = costRatio < 0.6 ? 'pass' : costRatio < 0.9 ? 'warn' : 'fail';
  $('scoreCostIcon').className = `scorecard-icon ${cClass}`;
  $('scoreCostIcon').textContent = cClass === 'pass' ? '‚úì' : cClass === 'warn' ? '!' : '‚úó';
  $('scoreCostText').textContent = costRatio < 1 ? `${((1 - costRatio) * 100).toFixed(0)}% below market` : 'Above market';

  const compareBtc = state.compareMode === 'dca' ? out.trueDcaBtc : out.cashMatchedBtc;
  const miningAdv = out.endingBtc - compareBtc;
  const advPct = compareBtc > 0 ? miningAdv / compareBtc : 0;
  let aClass = advPct > 0.1 ? 'pass' : advPct > 0 ? 'warn' : 'fail';
  $('scoreEdgeIcon').className = `scorecard-icon ${aClass}`;
  $('scoreEdgeIcon').textContent = aClass === 'pass' ? '‚úì' : aClass === 'warn' ? '!' : '‚úó';
  $('scoreEdgeText').textContent = advPct > 0 ? `+${(advPct * 100).toFixed(0)}% advantage` : `${(advPct * 100).toFixed(0)}% disadvantage`;

  const scores = [mClass, pClass, cClass, aClass];
  const passCount = scores.filter(s => s === 'pass').length;
  const grade = passCount >= 4 ? 'Excellent' : passCount >= 3 ? 'Good' : passCount >= 2 ? 'Fair' : 'Review Needed';
  const gClass = passCount >= 4 ? 'excellent' : passCount >= 3 ? 'good' : passCount >= 2 ? 'fair' : 'poor';
  $('investmentGrade').textContent = grade;
  $('investmentGrade').className = `grade-badge ${gClass}`;
}

function updateExecutiveComparison(out, sym) {
  const isDca = state.compareMode === 'dca';
  const compareBtc = isDca ? out.trueDcaBtc : out.cashMatchedBtc;
  const compareValue = isDca ? out.trueDcaValue : out.cashMatchedValue;
  const compareLabel = isDca ? 'üíµ True DCA' : 'üíµ Cash-Matched Buy';
  const compareNote = isDca
    ? 'True DCA: Total cash spread evenly across all months.'
    : 'Cash-Matched Buy: Same timing as mining (capex upfront, OPEX at each month\'s price).';

  $('execMiningBtc').textContent = fmtBtc(out.endingBtc, 4);
  $('execMiningValue').textContent = `${sym}${fmtMoney(toDisplay(out.endingValue))}`;
  $('execBuyBtc').textContent = fmtBtc(compareBtc, 4);
  $('execBuyValue').textContent = `${sym}${fmtMoney(toDisplay(compareValue))}`;
  $('buyingCardTitle').textContent = compareLabel;
  $('compareModeNote').textContent = compareNote;

  const mWins = out.endingBtc > compareBtc;
  $('miningCard').classList.toggle('winner', mWins);
  $('buyingCard').classList.toggle('winner', !mWins);

  const adv = out.endingBtc - compareBtc;
  $('execAdvValue').textContent = (adv >= 0 ? '+' : '') + fmtBtc(adv, 4) + ' BTC';
  $('execAdvValue').style.color = adv >= 0 ? 'var(--success)' : 'var(--danger)';
  $('execAdvDetail').textContent = `‚âà ${sym}${fmtMoney(Math.abs(toDisplay(adv * out.endingPrice)))} ${adv >= 0 ? 'additional' : 'less'} value`;
  $('advantageCard').style.background = adv >= 0 ? 'rgba(52,211,153,.08)' : 'rgba(248,113,113,.08)';

  const priceModelDesc = state.priceModel === 'custom' ? `Custom Annual` : `Cycle (${state.priceDrift}% drift)`;
  $('execAssumptions').innerHTML = `<strong>Miners:</strong> ${state.minerCount} √ó ${state.hashratePerMiner} TH/s ‚Ä¢ <strong>Capex:</strong> ${sym}${fmtMoney(toDisplay(out.capex))} ‚Ä¢ <strong>Power:</strong> $${state.powerCost}/kWh ‚Ä¢ <strong>Price Model:</strong> ${priceModelDesc}`;
}

function updateTimeline(out, sym) {
  const el = $('execTimeline');
  el.innerHTML = '';
  const curYr = Math.ceil(state.holdMonths / 12);
  out.yearlyData.forEach(y => {
    const div = document.createElement('div');
    div.className = `timeline-year${y.year === curYr ? ' current' : ''}`;
    div.innerHTML = `<div class="yr">Y${y.year}</div><div class="btc">${fmtBtc(y.btc, 3)}</div><div class="val">${sym}${fmtMoney(toDisplay(y.value))}</div>`;
    el.appendChild(div);
  });
}

function updateOverview(out, sym) {
  $('ovRevenue').textContent = `${sym}${fmtMoney(toDisplay(out.cumRevenue))}`;
  $('ovCosts').textContent = `${sym}${fmtMoney(toDisplay(out.capex + out.cumOpex))}`;
  const netCash = out.cumRevenue - out.cumOpex - out.capex + out.resaleAmount;
  $('ovNetCash').textContent = `${sym}${fmtMoney(toDisplay(netCash))}`;
  $('ovNetCash').style.color = netCash >= 0 ? 'var(--success)' : 'var(--danger)';
  $('ovIrr').textContent = out.irrA !== null ? fmtPct(out.irrA, 1) : 'N/A';
  $('ovMoic').textContent = fmtNum(out.moic, 2) + 'x';
  $('ovBtcMined').textContent = fmtBtc(out.endingBtc, 4);

  const isDca = state.compareMode === 'dca';
  const compareBtc = isDca ? out.trueDcaBtc : out.cashMatchedBtc;
  const compareValue = isDca ? out.trueDcaValue : out.cashMatchedValue;
  const compareLabel = isDca ? 'True DCA' : 'Cash-Matched Buy';
  const compareNote = isDca
    ? 'True DCA: Total cash spread evenly across all months.'
    : 'Cash-Matched Buy: Same timing as mining (capex upfront, OPEX at each month\'s price).';

  $('ovMiningBtc').textContent = fmtBtc(out.endingBtc, 4);
  $('ovMiningValue').textContent = `${sym}${fmtMoney(toDisplay(out.endingValue))}`;
  $('ovBuyBtc').textContent = fmtBtc(compareBtc, 4);
  $('ovBuyValue').textContent = `${sym}${fmtMoney(toDisplay(compareValue))}`;
  $('ovBuyingCardTitle').textContent = compareLabel;
  $('ovCompareModeNote').textContent = compareNote;
  $('ovMiningCard').classList.toggle('winner', out.endingBtc > compareBtc);
  $('ovBuyingCard').classList.toggle('winner', compareBtc > out.endingBtc);

  $('ovCostPerBtc').textContent = `${sym}${fmtMoney(toDisplay(out.costPerBtc))}`;
  $('ovMarketPrice').textContent = `${sym}${fmtMoney(toDisplay(getBtcPrice()))}`;
  const margin = getBtcPrice() > 0 ? (getBtcPrice() - out.costPerBtc) / getBtcPrice() * 100 : 0;
  $('ovMargin').textContent = margin >= 0 ? `+${margin.toFixed(0)}%` : `${margin.toFixed(0)}%`;
  $('ovMargin').style.color = margin >= 0 ? 'var(--success)' : 'var(--danger)';

  const yearlyEl = $('yearlyTiles');
  yearlyEl.innerHTML = '';
  out.yearlyData.forEach(y => {
    const div = document.createElement('div');
    div.className = 'tile';
    const yoy = y.year > 1 && out.yearlyData[y.year - 2] ? ((y.price / out.yearlyData[y.year - 2].price - 1) * 100) : ((y.price / getBtcPrice() - 1) * 100);
    div.innerHTML = `<h4>Year ${y.year}</h4><p>${sym}${fmtMoney(toDisplay(y.value))}</p><div class="sub">BTC: ${fmtBtc(y.btc, 4)}</div><div class="sub">Price YoY: ${yoy >= 0 ? '+' : ''}${yoy.toFixed(1)}%</div>`;
    yearlyEl.appendChild(div);
  });
}

function updateDashboard(out, sym) {
  const simM = Math.min(12, state.holdMonths);
  const curr = out.rows[simM - 1] || out.rows[0];
  const btcPrice = getBtcPrice();

  // Top KPI tiles
  $('dashBtcMined').textContent = fmtBtc(curr.btcHeld, 4);
  $('dashBtcChange').textContent = `+${fmtBtc(curr.netBtc, 4)} this month`;
  $('dashPortfolioValue').textContent = `${sym}${fmtMoney(toDisplay(curr.btcHeld * curr.price))}`;
  const ret = ((curr.btcHeld * curr.price - out.capex) / out.capex) * 100;
  $('dashPortfolioChange').textContent = `${ret >= 0 ? '+' : ''}${ret.toFixed(1)}% vs capex`;
  $('dashHashrate').textContent = `${fmtMoney(out.fleetHashTH)} TH/s`;
  $('dashUptimeStatus').textContent = `${state.uptime}% uptime`;
  $('dashCostPerBtc').textContent = `${sym}${fmtMoney(toDisplay(out.costPerBtc))}`;
  const margin = (1 - out.costPerBtc / btcPrice) * 100;
  $('dashCostMargin').textContent = `${margin >= 0 ? margin.toFixed(0) + '% below' : Math.abs(margin).toFixed(0) + '% above'} market`;

  // Break-even progress
  const breakEvenPct = out.breakevenMonth > 0 ? Math.min(100, (simM / out.breakevenMonth) * 100) : (curr.cumNetValue >= 0 ? 100 : (curr.btcHeld * curr.price / out.capex) * 100);
  $('dashBreakevenPct').textContent = `${breakEvenPct.toFixed(0)}%`;
  $('dashBreakevenBar').style.width = `${Math.min(100, breakEvenPct)}%`;
  const remaining = out.breakevenMonth > simM ? out.breakevenMonth - simM : 0;
  $('dashBreakevenRemaining').textContent = remaining > 0 ? `Estimated ${remaining} months remaining` : 'Break-even achieved!';

  // Period statistics (based on simulated period)
  const periodRows = out.rows.slice(0, simM);
  const sumGross = periodRows.reduce((a, r) => a + r.grossBtc, 0);
  const sumPoolFee = periodRows.reduce((a, r) => a + r.poolFeeBtc, 0);
  const sumNet = periodRows.reduce((a, r) => a + r.netBtc, 0);
  const sumPower = periodRows.reduce((a, r) => a + r.powerCost, 0);
  const sumOpFees = periodRows.reduce((a, r) => a + r.hostingCost + r.mgmtCost + r.insuranceCost + r.repairCost, 0);
  const sumNetCash = periodRows.reduce((a, r) => a + r.netCash, 0);

  $('dashGrossBtc').textContent = fmtBtc(sumGross, 4);
  $('dashPoolFees').textContent = `-${fmtBtc(sumPoolFee, 4)}`;
  $('dashNetBtc').textContent = fmtBtc(sumNet, 4);
  $('dashPowerCosts').textContent = `${sym}${fmtMoney(toDisplay(sumPower))}`;
  $('dashOpFees').textContent = `${sym}${fmtMoney(toDisplay(sumOpFees))}`;
  $('dashNetIncome').textContent = `${sym}${fmtMoney(toDisplay(sumNetCash))}`;
  $('dashNetIncome').style.color = sumNetCash >= 0 ? 'var(--success)' : 'var(--danger)';

  // Activity feed (simulated based on model)
  const lastRow = out.rows[simM - 1] || out.rows[0];
  $('dashActivityBlock').textContent = `+${fmtBtc(lastRow.netBtc / 30, 5)} BTC ‚Ä¢ 2 hours ago`;
  $('dashActivityPower').textContent = `-${sym}${fmtMoney(toDisplay(lastRow.powerCost))} ‚Ä¢ Yesterday`;
  $('dashActivityDiff').textContent = `+${(state.difficultyGrowth / 12).toFixed(1)}% increase ‚Ä¢ 3 days ago`;

  // Bottom tiles
  const year1Rows = out.rows.slice(0, Math.min(12, out.rows.length));
  const year1Btc = year1Rows.reduce((a, r) => a + r.netBtc, 0);
  const year1EndPrice = year1Rows[year1Rows.length - 1]?.price || btcPrice;
  $('dashYearEndBtc').textContent = fmtBtc(year1Btc, 3);
  $('dashYearEndValue').textContent = `${sym}${fmtMoney(toDisplay(year1Btc * year1EndPrice))}`;

  const hashShare = (out.fleetHashTH / (state.networkHashrateEH * 1e6)) * 100;
  $('dashHashShare').textContent = `${hashShare.toFixed(6)}%`;

  const efficiency = (state.powerPerMiner * 1000) / state.hashratePerMiner;
  $('dashEfficiency').textContent = `${efficiency.toFixed(1)} J/TH`;
}

function updateCashflow(out, sym) {
  const tbody = $('cashflowBody');
  tbody.innerHTML = '';
  const isAnnual = state.cashflowView === 'annual';

  if (isAnnual) {
    const years = Math.ceil(out.rows.length / 12);
    for (let y = 0; y < years; y++) {
      const slice = out.rows.slice(y * 12, (y + 1) * 12);
      if (!slice.length) continue;
      const sum = k => slice.reduce((a, r) => a + (r[k] || 0), 0);
      const last = slice[slice.length - 1];
      const tr = document.createElement('tr');
      tr.className = 'year-subtotal';
      tr.innerHTML = `<td>Year ${y + 1}</td><td>${fmtBtc(sum('grossBtc'), 4)}</td><td>${fmtBtc(sum('poolFeeBtc'), 4)}</td><td>${fmtBtc(sum('netBtc'), 4)}</td><td>${sym}${fmtMoney(toDisplay(last.price))}</td><td>${sym}${fmtMoney(toDisplay(sum('revenue')))}</td><td>${sym}${fmtMoney(toDisplay(sum('powerCost')))}</td><td>${sym}${fmtMoney(toDisplay(sum('hostingCost')))}</td><td>${sym}${fmtMoney(toDisplay(sum('mgmtCost')))}</td><td>${sym}${fmtMoney(toDisplay(sum('insuranceCost')))}</td><td>${sym}${fmtMoney(toDisplay(sum('repairCost')))}</td><td style="color:${sum('netCash') >= 0 ? 'var(--success)' : 'var(--danger)'}">${sym}${fmtMoney(toDisplay(sum('netCash')))}</td><td style="color:${last.cumNetValue >= 0 ? 'var(--success)' : 'var(--danger)'}">${sym}${fmtMoney(toDisplay(last.cumNetValue))}</td>`;
      tbody.appendChild(tr);
    }
  } else {
    out.rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>M${r.month}</td><td>${fmtBtc(r.grossBtc, 5)}</td><td>${fmtBtc(r.poolFeeBtc, 5)}</td><td>${fmtBtc(r.netBtc, 5)}</td><td>${sym}${fmtMoney(toDisplay(r.price))}</td><td>${sym}${fmtMoney(toDisplay(r.revenue))}</td><td>${sym}${fmtMoney(toDisplay(r.powerCost))}</td><td>${sym}${fmtMoney(toDisplay(r.hostingCost))}</td><td>${sym}${fmtMoney(toDisplay(r.mgmtCost))}</td><td>${sym}${fmtMoney(toDisplay(r.insuranceCost))}</td><td>${sym}${fmtMoney(toDisplay(r.repairCost))}</td><td style="color:${r.netCash >= 0 ? 'var(--success)' : 'var(--danger)'}">${sym}${fmtMoney(toDisplay(r.netCash))}</td><td style="color:${r.cumNetValue >= 0 ? 'var(--success)' : 'var(--danger)'}">${sym}${fmtMoney(toDisplay(r.cumNetValue))}</td>`;
      tbody.appendChild(tr);
    });
  }
}

function updateCharts(out) {
  const labels = out.rows.map(r => `M${r.month}`);
  const netValues = out.rows.map(r => r.cumNetValue);
  const btcHeld = out.rows.map(r => r.btcHeld);
  const revenues = out.rows.map(r => r.revenue);
  const costs = out.rows.map(r => r.totalOpex);

  // Shared tick config for cleaner axes - show every 3rd month
  const cleanXAxis = {
    grid: { color: 'rgba(38,54,71,.5)' },
    ticks: { color: '#8A95A3', maxTicksLimit: 20, callback: function(val, idx) { return (idx % 3 === 0) ? this.getLabelForValue(val) : ''; } }
  };
  const cleanYAxis = { grid: { color: 'rgba(38,54,71,.5)' }, ticks: { color: '#8A95A3' } };

  // Executive chart
  const ctx1 = $('execChart')?.getContext('2d');
  if (ctx1) {
    if (charts.exec) charts.exec.destroy();
    charts.exec = new Chart(ctx1, { type: 'line', data: { labels, datasets: [{ label: 'Net Value', data: netValues, borderColor: netValues[netValues.length - 1] >= 0 ? '#34D399' : '#F87171', backgroundColor: netValues[netValues.length - 1] >= 0 ? 'rgba(52,211,153,.1)' : 'rgba(248,113,113,.1)', fill: true, tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: cleanXAxis, y: cleanYAxis } } });
  }

  // Profitability chart
  const ctx2 = $('profitabilityChart')?.getContext('2d');
  if (ctx2) {
    if (charts.profit) charts.profit.destroy();
    let cumRev = 0, cumProfit = 0, cumPower = 0;
    const cumRevData = out.rows.map(r => { cumRev += r.revenue; return cumRev; });
    const cumProfitData = out.rows.map(r => { cumProfit += r.netCash; return cumProfit; });
    const cumPowerData = out.rows.map(r => { cumPower += r.powerCost; return cumPower; });
    charts.profit = new Chart(ctx2, { type: 'line', data: { labels, datasets: [{ label: 'Cumulative Revenue', data: cumRevData, borderColor: '#34D399', fill: false, tension: 0.3, pointRadius: 0 }, { label: 'Cumulative Profit', data: cumProfitData, borderColor: '#F7931A', fill: false, tension: 0.3, pointRadius: 0 }, { label: 'Cumulative Power', data: cumPowerData, borderColor: '#F87171', fill: false, tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#8A95A3' } } }, scales: { x: cleanXAxis, y: cleanYAxis } } });
  }

  // Dashboard accumulation chart
  const ctx3 = $('dashAccumChart')?.getContext('2d');
  if (ctx3) {
    if (charts.dashAccum) charts.dashAccum.destroy();
    charts.dashAccum = new Chart(ctx3, { type: 'line', data: { labels, datasets: [{ label: 'BTC Held', data: btcHeld, borderColor: '#F7931A', backgroundColor: 'rgba(247,147,26,.1)', fill: true, tension: 0.3, pointRadius: 2, pointBackgroundColor: '#F7931A' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: cleanXAxis, y: cleanYAxis } } });
  }

  // Dashboard revenue vs costs chart
  const ctx4 = $('dashRevenueChart')?.getContext('2d');
  if (ctx4) {
    if (charts.dashRev) charts.dashRev.destroy();
    const barLabels = labels.slice(0, 24);
    charts.dashRev = new Chart(ctx4, { type: 'bar', data: { labels: barLabels, datasets: [{ label: 'Revenue', data: revenues.slice(0, 24), backgroundColor: 'rgba(52,211,153,.6)' }, { label: 'Costs', data: costs.slice(0, 24), backgroundColor: 'rgba(248,113,113,.6)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#8A95A3' } } }, scales: { x: { grid: { display: false }, ticks: { color: '#8A95A3', maxTicksLimit: 12, callback: function(val, idx) { return (idx % 2 === 0) ? this.getLabelForValue(val) : ''; } } }, y: cleanYAxis } } });
  }
}

function updatePriceDisplays() {
  const sym = symbolFor(state.currency);
  const p0 = getBtcPrice();
  const prices = getPrices(60);
  [1, 2, 3, 4, 5].forEach(y => {
    const el = $(`priceY${y}Display`);
    if (el) {
      const p = prices[y * 12] || p0;
      el.textContent = `${sym}${fmtMoney(toDisplay(p))}`;
      el.classList.toggle('negative', p < p0);
    }
  });
  $('cycleDetails').textContent = `${state.priceDrift}% drift, ¬±${state.priceCycleAmp}% amplitude`;

  // Sparkline
  const ctx = $('priceSparkline')?.getContext('2d');
  if (ctx && state.priceModel === 'custom') {
    if (charts.sparkline) charts.sparkline.destroy();
    const data = [p0];
    for (let y = 1; y <= 5; y++) data.push(prices[y * 12] || p0);
    charts.sparkline = new Chart(ctx, { type: 'line', data: { labels: ['Start', 'Y1', 'Y2', 'Y3', 'Y4', 'Y5'], datasets: [{ data, borderColor: '#F7931A', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });
  }
}

function renderSensitivity() {
  const sym = symbolFor(state.currency);
  const basePrice = getBtcPrice();
  const baseDiff = state.difficultyGrowth;
  const basePower = state.powerCost;

  const priceScens = [{ label: '-30%', mult: 0.7 }, { label: '-15%', mult: 0.85 }, { label: 'Base', mult: 1 }, { label: '+15%', mult: 1.15 }, { label: '+30%', mult: 1.3 }];
  const diffScens = [5, 15, 25, 35];

  const tbody = $('sensitivityBody');
  tbody.innerHTML = '';

  for (const ps of priceScens) {
    const tr = document.createElement('tr');
    const adjPrice = Math.round(basePrice * ps.mult);
    let cells = [`<td><strong>${ps.label}</strong><br><span class="muted">${sym}${adjPrice.toLocaleString()}</span></td>`];

    for (const diff of diffScens) {
      const adj = { difficultyGrowth: diff, btcOverride: String(adjPrice) };
      if (state.priceModel === 'custom') {
        adj.priceY1 = Math.round(state.priceY1 * ps.mult);
        adj.priceY2 = Math.round(state.priceY2 * ps.mult);
        adj.priceY3 = Math.round(state.priceY3 * ps.mult);
        adj.priceY4 = Math.round(state.priceY4 * ps.mult);
        adj.priceY5 = Math.round(state.priceY5 * ps.mult);
      }
      const out = modelWith(adj);
      const moic = out.moicNoResale;
      let style = moic >= 1.5 ? 'background:rgba(52,211,153,.15);color:#34d399' : moic >= 1 ? 'background:rgba(251,191,36,.1)' : 'background:rgba(248,113,113,.15);color:#f87171';
      const isCurrent = Math.abs(diff - baseDiff) < 3 && Math.abs(ps.mult - 1) < 0.05;
      if (isCurrent) style = 'background:rgba(96,165,250,.2);border:2px solid rgba(96,165,250,.5)';
      cells.push(`<td style="${style}"><strong>${fmtNum(moic, 2)}x</strong></td>`);
    }
    tr.innerHTML = cells.join('');
    tbody.appendChild(tr);
  }

  // Power sensitivity - uses Cash-Adjusted MOIC to show power cost impact
  const tbody2 = $('powerSensitivityBody');
  if (tbody2) {
    tbody2.innerHTML = '';
    const powerScens = [0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.10];
    for (const pwr of powerScens) {
      const out = modelWith({ powerCost: pwr });
      // Cash-Adjusted MOIC = (BTC Value + Net Cash Position) / Capex
      // Net Cash Position = cumRevenue - cumOpex (negative if cash outflow exceeds revenue)
      const netCashPosition = out.cumRevenue - out.cumOpex;
      const totalValue = out.endingValue + netCashPosition;
      const cashAdjMoic = out.capex > 0 ? totalValue / out.capex : 0;
      const monthlyOpex = out.rows.length > 0 ? out.rows[0].totalOpex : 0;
      const breakeven = out.cumBtcNet > 0 ? (out.capex + out.cumOpex) / out.cumBtcNet : 0;
      const tr = document.createElement('tr');
      const isCurrent = Math.abs(pwr - basePower) < 0.005;
      const rowStyle = isCurrent ? 'background:rgba(96,165,250,.1)' : '';
      const moicColor = cashAdjMoic >= 1.5 ? 'color:#34d399' : cashAdjMoic < 1 ? 'color:#f87171' : '';
      tr.innerHTML = `<td style="${rowStyle}"><strong>${sym}${pwr.toFixed(2)}</strong>${isCurrent ? ' <span class="muted">(current)</span>' : ''}</td><td style="${rowStyle};${moicColor}"><strong>${fmtNum(cashAdjMoic, 2)}x</strong></td><td style="${rowStyle}">${sym}${fmtMoney(toDisplay(monthlyOpex))}</td><td style="${rowStyle}">${sym}${fmtMoney(toDisplay(breakeven))}</td>`;
      tbody2.appendChild(tr);
    }
  }
}

function randn() { let u = 0, v = 0; while (u === 0) u = Math.random(); while (v === 0) v = Math.random(); return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v); }

async function runMonteCarlo(runs = 1000) {
  const scen = SCENARIOS[state.scenario] || SCENARIOS.base;
  const saved = JSON.parse(JSON.stringify(state));
  const basePrice = getBtcPrice();

  $('mcProgress').style.display = 'block';
  $('mcProgressBar').style.width = '0%';
  $('rerunMC').textContent = 'Running...';
  $('rerunMC').disabled = true;

  let countMoic = 0, countBE = 0, sumBtc = 0;
  const moicResults = [];

  const batchSize = 50;
  for (let done = 0; done < runs;) {
    const end = Math.min(done + batchSize, runs);
    for (let i = done; i < end; i++) {
      state.priceDrift = clamp(scen.drift + randn() * 10, -30, 80);
      state.priceCycleAmp = clamp(scen.amp + randn() * 15, 0, 120);
      state.difficultyGrowth = clamp(saved.difficultyGrowth + randn() * 10, -20, 80);
      state.btcOverride = String(basePrice);

      const out = model();
      const m18 = Math.min(18, out.rows.length);
      const net18 = m18 > 0 ? out.rows[m18 - 1].cumNetValue : -out.capex;
      if (out.moic > 1.5) countMoic++;
      if (net18 >= 0) countBE++;
      sumBtc += out.endingBtc;
      moicResults.push(out.moicNoResale);
    }
    done = end;
    $('mcProgressBar').style.width = `${(done / runs) * 100}%`;
    $('mcProbMoic').textContent = fmtNum(100 * countMoic / done, 1);
    $('mcProbBreakeven').textContent = fmtNum(100 * countBE / done, 1);
    $('mcAvgBtc').textContent = fmtBtc(sumBtc / done, 4);
    await new Promise(r => requestAnimationFrame(r));
  }

  state = saved;
  $('mcProgress').style.display = 'none';
  $('rerunMC').textContent = 'Re-run Monte Carlo';
  $('rerunMC').disabled = false;

  // Histogram
  const ctx = $('mcChart')?.getContext('2d');
  if (ctx) {
    if (charts.mc) charts.mc.destroy();
    const buckets = {};
    moicResults.forEach(m => { const b = Math.floor(m * 4) / 4; buckets[b] = (buckets[b] || 0) + 1; });
    const labels = Object.keys(buckets).sort((a, b) => a - b);
    const data = labels.map(l => buckets[l]);
    charts.mc = new Chart(ctx, { type: 'bar', data: { labels: labels.map(l => l + 'x'), datasets: [{ label: 'Frequency', data, backgroundColor: 'rgba(247,147,26,.6)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#8A95A3' } }, y: { grid: { color: 'rgba(38,54,71,.5)' }, ticks: { color: '#8A95A3' } } } } });
  }
}

// Bind all events
function bindEvents() {
  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      $(btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'sensitivity') renderSensitivity();
      if (btn.dataset.tab === 'montecarlo') runMonteCarlo();
    });
  });

  // Compare mode toggle (DCA vs Cash-Matched)
  document.querySelectorAll('.compare-mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.compare-mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.compareMode = btn.dataset.mode;
      updateAll();
    });
  });

  // Price model
  document.querySelectorAll('.price-model-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.price-model-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.priceModel = btn.dataset.mode;
      $('customPriceControls').style.display = state.priceModel === 'custom' ? 'block' : 'none';
      $('cycleModelNote').style.display = state.priceModel === 'cycle' ? 'block' : 'none';
      modelCache.key = null;
      updateAll();
    });
  });

  // Price presets
  document.querySelectorAll('.price-preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.price-preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const preset = PRESETS[btn.dataset.preset];
      if (preset) {
        state.priceY1 = preset.y1; state.priceY2 = preset.y2; state.priceY3 = preset.y3; state.priceY4 = preset.y4; state.priceY5 = preset.y5;
        $('priceY1').value = preset.y1; $('priceY2').value = preset.y2; $('priceY3').value = preset.y3; $('priceY4').value = preset.y4; $('priceY5').value = preset.y5;
      }
      state.pricePreset = btn.dataset.preset;
      modelCache.key = null;
      updateAll();
    });
  });

  // Year inputs
  ['priceY1', 'priceY2', 'priceY3', 'priceY4', 'priceY5'].forEach(id => {
    const el = $(id);
    if (el) el.addEventListener('input', () => { state[id] = clamp(+el.value || 0, -90, 500); modelCache.key = null; updateAll(); });
  });

  // Miner counter
  $('minerMinus').addEventListener('click', () => { state.minerCount = Math.max(1, state.minerCount - 10); $('minerCount').value = state.minerCount; modelCache.key = null; updateAll(); });
  $('minerPlus').addEventListener('click', () => { state.minerCount += 10; $('minerCount').value = state.minerCount; modelCache.key = null; updateAll(); });

  // Advanced toggle
  $('toggleAdvanced').addEventListener('click', () => {
    const p = $('advancedAssumptions');
    p.classList.toggle('collapsed');
    $('toggleAdvanced').textContent = p.classList.contains('collapsed') ? 'Show' : 'Hide';
  });

  // Cashflow toggle
  $('toggleCashflowView').addEventListener('click', () => {
    state.cashflowView = state.cashflowView === 'monthly' ? 'annual' : 'monthly';
    $('toggleCashflowView').textContent = state.cashflowView === 'monthly' ? 'Switch to Annual' : 'Switch to Monthly';
    updateCashflow(model(), symbolFor(state.currency));
  });

  // Reset
  $('resetBtn').addEventListener('click', () => { state = JSON.parse(JSON.stringify(DEFAULTS)); applyStateToUI(); modelCache.key = null; updateAll(); });

  // Fetch network hashrate
  $('fetchHashrateBtn').addEventListener('click', fetchNetworkHashrate);

  // Fetch FX rate
  $('refreshFx').addEventListener('click', fetchFxRate);

  // MC rerun
  $('rerunMC').addEventListener('click', () => runMonteCarlo());

  // Share
  $('shareBtn').addEventListener('click', async () => {
    const params = new URLSearchParams();
    Object.entries(state).forEach(([k, v]) => params.set(k, v));
    const url = `${location.origin}${location.pathname}?${params}`;
    try { await navigator.clipboard.writeText(url); $('shareBtn').textContent = 'Copied!'; setTimeout(() => $('shareBtn').textContent = 'Share', 1500); } catch { prompt('Copy:', url); }
  });

  // CSV export
  $('exportBtn').addEventListener('click', () => {
    const out = model();
    const csv = ['Month,Gross BTC,Net BTC,Price,Revenue,Power,Total OPEX,Net Cash,Cumulative'];
    out.rows.forEach(r => csv.push(`${r.month},${r.grossBtc},${r.netBtc},${r.price},${r.revenue},${r.powerCost},${r.totalOpex},${r.netCash},${r.cumNetValue}`));
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pantheon_cashflow.csv'; a.click();
  });

  // HTML Report export
  $('exportHtmlBtn').addEventListener('click', () => {
    const html = buildReportHtml();
    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
  });

  // Price refresh
  $('refreshPrice').addEventListener('click', fetchBtcPrice);

  // Miner model
  $('minerModel').addEventListener('change', () => {
    const opt = $('minerModel').selectedOptions[0];
    state.minerModel = $('minerModel').value;
    state.hashratePerMiner = +opt.dataset.hash;
    state.powerPerMiner = +opt.dataset.power;
    state.unitCapex = +opt.dataset.capex;
    $('hashratePerMiner').value = state.hashratePerMiner;
    $('hashratePerMinerRange').value = state.hashratePerMiner;
    $('powerPerMiner').value = state.powerPerMiner;
    $('powerPerMinerRange').value = state.powerPerMiner;
    $('unitCapex').value = state.unitCapex;
    $('unitCapexRange').value = state.unitCapex;
    modelCache.key = null;
    updateAll();
  });

  // Currency
  $('currency').addEventListener('change', () => { state.currency = $('currency').value; updateAll(); });

  // Reinvest
  $('reinvestBtc').addEventListener('change', () => { state.reinvestBtc = $('reinvestBtc').checked; modelCache.key = null; updateAll(); });

  // All sliders and numeric inputs
  const fields = ['minerCount', 'holdMonths', 'fxRate', 'btcOverride', 'priceDrift', 'priceCycleAmp', 'priceCycleMonths', 'unitCapex', 'powerCost', 'hashratePerMiner', 'powerPerMiner', 'networkHashrateEH', 'uptime', 'poolFee', 'hostingFee', 'managementFee', 'insuranceFee', 'repairReserve', 'degradation', 'difficultyGrowth', 'resaleValue'];
  const debouncedUpdate = debounce(() => { modelCache.key = null; updateAll(); }, 100);

  fields.forEach(f => {
    const el = $(f);
    const range = $(f + 'Range');
    if (el) {
      el.addEventListener('input', () => {
        state[f] = el.type === 'checkbox' ? el.checked : +el.value;
        if (range) range.value = el.value;
        debouncedUpdate();
      });
    }
    if (range) {
      range.addEventListener('input', () => {
        state[f] = +range.value;
        if (el) el.value = range.value;
        debouncedUpdate();
      });
    }
  });

  // Hold months sync
  $('holdMonthsRange').addEventListener('input', () => { state.holdMonths = +$('holdMonthsRange').value; $('holdMonths').value = state.holdMonths; debouncedUpdate(); });
  $('holdMonths').addEventListener('input', () => { state.holdMonths = +$('holdMonths').value; $('holdMonthsRange').value = state.holdMonths; debouncedUpdate(); });

  // Halving anchor
  $('halvingAnchor').addEventListener('change', () => { state.halvingAnchor = $('halvingAnchor').value; modelCache.key = null; updateAll(); });
}

function applyStateToUI() {
  $('minerModel').value = state.minerModel;
  $('currency').value = state.currency;
  $('fxRate').value = state.fxRate;
  $('minerCount').value = state.minerCount;
  $('holdMonths').value = state.holdMonths;
  $('holdMonthsRange').value = state.holdMonths;
  $('btcOverride').value = state.btcOverride || '';
  $('priceDrift').value = state.priceDrift;
  $('priceDriftRange').value = state.priceDrift;
  $('priceCycleAmp').value = state.priceCycleAmp;
  $('priceCycleAmpRange').value = state.priceCycleAmp;
  $('priceCycleMonths').value = state.priceCycleMonths;
  $('priceCycleMonthsRange').value = state.priceCycleMonths;
  $('halvingAnchor').value = state.halvingAnchor;
  $('unitCapex').value = state.unitCapex;
  $('unitCapexRange').value = state.unitCapex;
  $('powerCost').value = state.powerCost;
  $('powerCostRange').value = state.powerCost;
  $('hashratePerMiner').value = state.hashratePerMiner;
  $('hashratePerMinerRange').value = state.hashratePerMiner;
  $('powerPerMiner').value = state.powerPerMiner;
  $('powerPerMinerRange').value = state.powerPerMiner;
  $('networkHashrateEH').value = state.networkHashrateEH;
  $('networkHashrateEHRange').value = state.networkHashrateEH;
  $('uptime').value = state.uptime;
  $('uptimeRange').value = state.uptime;
  $('poolFee').value = state.poolFee;
  $('poolFeeRange').value = state.poolFee;
  $('hostingFee').value = state.hostingFee;
  $('hostingFeeRange').value = state.hostingFee;
  $('managementFee').value = state.managementFee;
  $('managementFeeRange').value = state.managementFee;
  $('insuranceFee').value = state.insuranceFee;
  $('insuranceFeeRange').value = state.insuranceFee;
  $('repairReserve').value = state.repairReserve;
  $('repairReserveRange').value = state.repairReserve;
  $('degradation').value = state.degradation;
  $('degradationRange').value = state.degradation;
  $('difficultyGrowth').value = state.difficultyGrowth;
  $('difficultyGrowthRange').value = state.difficultyGrowth;
  $('resaleValue').value = state.resaleValue;
  $('resaleRange').value = state.resaleValue;
  $('reinvestBtc').checked = state.reinvestBtc;
  $('priceY1').value = state.priceY1;
  $('priceY2').value = state.priceY2;
  $('priceY3').value = state.priceY3;
  $('priceY4').value = state.priceY4;
  $('priceY5').value = state.priceY5;

  document.querySelectorAll('.price-model-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === state.priceModel));
  document.querySelectorAll('.price-preset-btn').forEach(b => b.classList.toggle('active', b.dataset.preset === state.pricePreset));
  document.querySelectorAll('.compare-mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === state.compareMode));

  $('customPriceControls').style.display = state.priceModel === 'custom' ? 'block' : 'none';
  $('cycleModelNote').style.display = state.priceModel === 'cycle' ? 'block' : 'none';
}

async function fetchBtcPrice() {
  $('currentBtcPrice').value = 'Loading...';
  try {
    const res = await fetch('https://api.coinbase.com/v2/prices/BTC-USD/spot');
    const data = await res.json();
    btcSpotUSD = +data.data.amount;
    $('currentBtcPrice').value = '$' + fmtMoney(btcSpotUSD);
    modelCache.key = null;
    updateAll();
  } catch { $('currentBtcPrice').value = 'Failed - use override'; }
}

async function fetchNetworkHashrate() {
  const btn = $('fetchHashrateBtn');
  const status = $('hashrateStatus');
  btn.disabled = true;
  btn.textContent = '‚ü≥ Fetching...';
  status.textContent = '';
  status.style.color = 'var(--muted)';

  let eh = null;

  // Try mempool.space API first (reliable CORS)
  try {
    const res = await fetch('https://mempool.space/api/v1/mining/hashrate/1w', {cache: 'no-store'});
    if (res.ok) {
      const json = await res.json();
      const current = json?.currentHashrate || json?.hashrates?.[json.hashrates.length - 1]?.avgHashrate;
      if (Number.isFinite(current) && current > 0) {
        eh = current / 1e18; // H/s to EH/s
      }
    }
  } catch {}

  // Fallback: Blockchain.info API
  if (!eh) {
    try {
      const res = await fetch('https://api.blockchain.info/charts/hash-rate?timespan=30days&format=json&sampled=true', {cache: 'no-store'});
      if (res.ok) {
        const json = await res.json();
        const values = Array.isArray(json?.values) ? json.values : [];
        const last = values.length ? values[values.length - 1] : null;
        const th = Number(last?.y);
        if (Number.isFinite(th) && th > 0) {
          eh = th / 1_000_000; // TH/s to EH/s
        }
      }
    } catch {}
  }

  if (eh && Number.isFinite(eh) && eh > 0) {
    const rounded = Math.round(eh);
    state.networkHashrateEH = rounded;
    $('networkHashrateEH').value = rounded;
    $('networkHashrateEHRange').value = rounded;
    status.textContent = `‚úì ${rounded.toLocaleString()} EH/s`;
    status.style.color = 'var(--success)';
    modelCache.key = null;
    updateAll();
  } else {
    status.textContent = 'Failed ‚Äî enter manually';
    status.style.color = 'var(--warn)';
  }

  btn.disabled = false;
  btn.textContent = '‚ü≥ Fetch Live';
}

async function fetchFxRate() {
  const btn = $('refreshFx');
  const input = $('fxRate');
  btn.disabled = true;
  btn.textContent = '...';

  let rate = null;

  // Try open.er-api.com (no key required)
  try {
    const res = await fetch('https://open.er-api.com/v6/latest/USD', { cache: 'no-store' });
    if (res.ok) {
      const json = await res.json();
      rate = json?.rates?.EUR;
    }
  } catch {}

  // Fallback: exchangerate-api
  if (!rate) {
    try {
      const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD', { cache: 'no-store' });
      if (res.ok) {
        const json = await res.json();
        rate = json?.rates?.EUR;
      }
    } catch {}
  }

  if (rate && Number.isFinite(rate) && rate > 0) {
    state.fxRate = +rate.toFixed(4);
    input.value = state.fxRate;
    modelCache.key = null;
    updateAll();
  }

  btn.disabled = false;
  btn.textContent = '‚Üª';
}

function buildReportHtml() {
  const out = model();
  const sym = symbolFor(state.currency);
  const ts = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const timeStr = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

  // Try to embed chart as image
  let chartImg = '';
  const c = $('execChart');
  try { if (c && c.toDataURL) chartImg = c.toDataURL('image/png'); } catch {}

  const irrVal = out.irrANoResale;
  const irrStr = irrVal === null ? '‚Äî' : `${(irrVal * 100).toFixed(1)}%`;
  const moicVal = out.moicNoResale;
  const moicStr = `${moicVal.toFixed(2)}x`;
  const paybackMonths = out.paybackMonth ? `${out.paybackMonth}` : '‚Äî';

  // Comparison (based on selected mode)
  const isDca = state.compareMode === 'dca';
  const compareBtc = isDca ? out.trueDcaBtc : out.cashMatchedBtc;
  const compareLabel = isDca ? 'True DCA' : 'Cash-Matched Buy';
  const miningAdvantage = out.endingBtc - compareBtc;
  const advPct = compareBtc > 0 ? ((out.endingBtc / compareBtc - 1) * 100) : 0;

  // Cost per BTC
  const costPerBtc = out.costPerBtc;
  const btcPrice = getBtcPrice();

  // Determine grade
  let grade = 'Review', gradeColor = '#94A3B8';
  if (moicVal >= 1.5 && out.paybackMonth && out.paybackMonth <= 36) { grade = 'Excellent'; gradeColor = '#10B981'; }
  else if (moicVal >= 1.2) { grade = 'Good'; gradeColor = '#3B82F6'; }
  else if (moicVal >= 1.0) { grade = 'Fair'; gradeColor = '#F59E0B'; }

  // Price model description
  let priceModelDesc = '';
  let priceProjectionsHtml = '';
  if (state.priceModel === 'custom') {
    priceModelDesc = `Custom Annual`;
    priceProjectionsHtml = `
        <tr><td>Year 1 Price Change</td><td>${state.priceY1 >= 0 ? '+' : ''}${state.priceY1}%</td></tr>
        <tr><td>Year 2 Price Change</td><td>${state.priceY2 >= 0 ? '+' : ''}${state.priceY2}%</td></tr>
        <tr><td>Year 3 Price Change</td><td>${state.priceY3 >= 0 ? '+' : ''}${state.priceY3}%</td></tr>
        <tr><td>Year 4 Price Change</td><td>${state.priceY4 >= 0 ? '+' : ''}${state.priceY4}%</td></tr>
        <tr><td>Year 5 Price Change</td><td>${state.priceY5 >= 0 ? '+' : ''}${state.priceY5}%</td></tr>`;
  } else {
    priceModelDesc = `Cycle Model: ${state.priceDrift > 0 ? '+' : ''}${state.priceDrift.toFixed(0)}%/yr drift, ¬±${state.priceCycleAmp}% amplitude`;
  }

  // 5-year BTC accumulation
  const yearlyBtc = [];
  const prices = getPrices(60);
  for (let yr = 1; yr <= 5; yr++) {
    const endMonth = Math.min(yr * 12, out.rows.length);
    const btc = out.rows.slice(0, endMonth).reduce((a, r) => a + r.netBtc, 0);
    const price = prices[endMonth] || prices[prices.length - 1];
    yearlyBtc.push({ yr, btc, value: btc * price });
  }

  return `<!doctype html>
<html><head><meta charset="utf-8">
<title>Pantheon Mining - Investment Snapshot</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root { --bg-dark: #0B1C2D; --bg-card: #162638; --gold: #D4A85A; --gold-light: #E8C88B; --text: #F5F7FA; --muted: #8A95A3; --success: #10B981; --border: rgba(212,168,90,.2); }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(135deg, #0B1C2D 0%, #0F2438 50%, #0B1C2D 100%); color: var(--text); min-height: 100vh; padding: 32px; }
  .container { max-width: 900px; margin: 0 auto; }
  .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 24px; border-bottom: 1px solid var(--border); margin-bottom: 28px; }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800; color: var(--bg-dark); }
  .logo-text { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
  .logo-sub { font-size: 12px; color: var(--gold); font-weight: 500; margin-top: 2px; }
  .header-right { text-align: right; }
  .header-right .project { font-size: 14px; font-weight: 600; }
  .header-right .details { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .header-right .timestamp { font-size: 11px; color: var(--muted); margin-top: 6px; opacity: 0.7; }
  .grade-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px; }
  .hero { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
  .hero-card { background: linear-gradient(135deg, rgba(22,38,56,.9), rgba(15,30,43,.8)); border: 1px solid var(--border); border-radius: 16px; padding: 24px; text-align: center; position: relative; overflow: hidden; }
  .hero-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
  .hero-card.highlight { border-color: rgba(212,168,90,.4); background: linear-gradient(135deg, rgba(212,168,90,.1), rgba(15,30,43,.8)); }
  .hero-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
  .hero-value { font-size: 42px; font-weight: 800; line-height: 1; margin-bottom: 8px; background: linear-gradient(135deg, var(--text), #B8C5D3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .hero-card.highlight .hero-value { background: linear-gradient(135deg, var(--gold), var(--gold-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .hero-card.positive .hero-value { background: linear-gradient(135deg, #34D399, #10B981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .hero-sub { font-size: 12px; color: var(--muted); }
  .section { margin-bottom: 24px; }
  .section-title { font-size: 13px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--border), transparent); }
  .comparison { display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: stretch; margin-bottom: 24px; }
  .compare-card { background: rgba(22,38,56,.6); border: 1px solid rgba(35,48,71,.8); border-radius: 14px; padding: 20px; text-align: center; }
  .compare-card.winner { border-color: rgba(16,185,129,.4); background: linear-gradient(135deg, rgba(16,185,129,.1), rgba(22,38,56,.6)); }
  .compare-method { font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 10px; }
  .compare-btc { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
  .compare-card.winner .compare-btc { color: var(--success); }
  .compare-label { font-size: 11px; color: var(--muted); }
  .compare-vs { display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: var(--muted); }
  .advantage-banner { background: linear-gradient(90deg, rgba(16,185,129,.15), transparent); border-left: 3px solid var(--success); padding: 14px 18px; border-radius: 0 12px 12px 0; margin-bottom: 24px; }
  .advantage-banner.negative { background: linear-gradient(90deg, rgba(239,68,68,.15), transparent); border-left-color: #EF4444; }
  .advantage-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .advantage-value { font-size: 20px; font-weight: 700; color: var(--success); margin-top: 4px; }
  .advantage-banner.negative .advantage-value { color: #EF4444; }
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: rgba(22,38,56,.5); border: 1px solid rgba(35,48,71,.6); border-radius: 12px; padding: 14px; }
  .stat-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
  .stat-value { font-size: 16px; font-weight: 700; }
  .timeline { display: flex; gap: 8px; margin-bottom: 24px; }
  .timeline-year { flex: 1; background: rgba(22,38,56,.5); border: 1px solid rgba(35,48,71,.6); border-radius: 10px; padding: 12px 8px; text-align: center; }
  .timeline-yr { font-size: 10px; font-weight: 600; color: var(--gold); margin-bottom: 6px; }
  .timeline-btc { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
  .timeline-val { font-size: 10px; color: var(--muted); }
  .chart-container { background: rgba(15,23,42,.4); border: 1px solid rgba(35,48,71,.6); border-radius: 14px; padding: 16px; margin-bottom: 24px; }
  .chart-container img { width: 100%; border-radius: 10px; }
  .drivers-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 24px; }
  .drivers-table td { padding: 10px 12px; border-bottom: 1px solid rgba(35,48,71,.4); }
  .drivers-table td:first-child { color: var(--muted); width: 60%; }
  .drivers-table td:last-child { text-align: right; font-weight: 600; }
  .footer { margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border); }
  .footer-risks { font-size: 11px; color: var(--muted); line-height: 1.6; margin-bottom: 16px; }
  .footer-disclaimer { font-size: 10px; color: var(--muted); opacity: 0.6; text-align: center; }
  @media print {
    body { background: white; color: #1a1a2e; padding: 20px; }
    .hero-card, .stat-card, .compare-card, .timeline-year, .chart-container { background: #f8f9fa; border-color: #e5e7eb; }
    .hero-value, .hero-card.highlight .hero-value, .hero-card.positive .hero-value { background: none; -webkit-text-fill-color: #1a1a2e; }
    .section-title { color: #D4A85A; }
    .hero-label, .stat-label, .compare-method, .compare-label, .hero-sub { color: #6b7280; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-icon">P</div>
        <div>
          <div class="logo-text">Pantheon Mining</div>
          <div class="logo-sub">Investment Snapshot</div>
        </div>
      </div>
      <div class="header-right">
        <div class="project">Mining Operation</div>
        <div class="details">${state.minerCount.toLocaleString()} miners ¬∑ ${state.holdMonths} month hold</div>
        <div class="timestamp">Generated ${ts} at ${timeStr}</div>
      </div>
    </div>

    <div class="grade-badge" style="background:${gradeColor}22; color:${gradeColor}; border:1px solid ${gradeColor}44">
      <span>‚óè</span> Investment Grade: ${grade}
    </div>

    <div class="hero">
      <div class="hero-card highlight">
        <div class="hero-label">Return Multiple</div>
        <div class="hero-value">${moicStr}</div>
        <div class="hero-sub">MOIC (BTC value only)</div>
      </div>
      <div class="hero-card${irrVal !== null && irrVal >= 0.15 ? ' positive' : ''}">
        <div class="hero-label">Annualized Return</div>
        <div class="hero-value">${irrStr}</div>
        <div class="hero-sub">IRR (pre-tax)</div>
      </div>
      <div class="hero-card${paybackMonths !== '‚Äî' && parseInt(paybackMonths) <= 30 ? ' positive' : ''}">
        <div class="hero-label">Capital Recovery</div>
        <div class="hero-value">${paybackMonths}</div>
        <div class="hero-sub">months to payback</div>
      </div>
    </div>

    <div class="section-title">Mining vs. ${compareLabel}</div>
    <div class="comparison">
      <div class="compare-card${out.endingBtc > compareBtc ? ' winner' : ''}">
        <div class="compare-method">‚õèÔ∏è Mining</div>
        <div class="compare-btc">${fmtBtc(out.endingBtc, 4)}</div>
        <div class="compare-label">BTC acquired</div>
      </div>
      <div class="compare-vs">VS</div>
      <div class="compare-card${compareBtc > out.endingBtc ? ' winner' : ''}">
        <div class="compare-method">üíµ ${compareLabel}</div>
        <div class="compare-btc">${fmtBtc(compareBtc, 4)}</div>
        <div class="compare-label">BTC acquired</div>
      </div>
    </div>

    <div class="advantage-banner${miningAdvantage < 0 ? ' negative' : ''}">
      <div class="advantage-label">Mining ${miningAdvantage >= 0 ? 'Advantage' : 'Disadvantage'}</div>
      <div class="advantage-value">${miningAdvantage >= 0 ? '+' : ''}${fmtBtc(miningAdvantage, 4)} BTC (${advPct >= 0 ? '+' : ''}${advPct.toFixed(1)}%)</div>
    </div>

    <div class="section-title">Investment Summary</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Capex</div>
        <div class="stat-value">${sym}${fmtMoney(toDisplay(out.capex))}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Cost per BTC</div>
        <div class="stat-value">${sym}${fmtMoney(toDisplay(costPerBtc))}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ending BTC</div>
        <div class="stat-value">${fmtBtc(out.endingBtc, 4)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ending Value</div>
        <div class="stat-value">${sym}${fmtMoney(toDisplay(out.endingValue))}</div>
      </div>
    </div>

    <div class="section-title">5-Year BTC Accumulation</div>
    <div class="timeline">
      ${yearlyBtc.map(y => `
        <div class="timeline-year">
          <div class="timeline-yr">Year ${y.yr}</div>
          <div class="timeline-btc">${fmtBtc(y.btc, 3)}</div>
          <div class="timeline-val">${sym}${fmtMoney(toDisplay(y.value))}</div>
        </div>
      `).join('')}
    </div>

    ${chartImg ? `
    <div class="section-title">Net Value Projection</div>
    <div class="chart-container">
      <img src="${chartImg}" alt="Net Value Chart">
    </div>
    ` : ''}

    <div class="section-title">Model Assumptions</div>
    <table class="drivers-table">
      <tbody>
        <tr><td>Starting BTC Price</td><td>${sym}${fmtMoney(toDisplay(btcPrice))}</td></tr>
        <tr><td>Price Model</td><td>${priceModelDesc}</td></tr>
        ${priceProjectionsHtml}
        <tr><td>Power Cost</td><td>${sym}${state.powerCost.toFixed(3)} / kWh</td></tr>
        <tr><td>Network Hashrate</td><td>${state.networkHashrateEH} EH/s</td></tr>
        <tr><td>Difficulty Growth (annual)</td><td>${state.difficultyGrowth.toFixed(1)}%</td></tr>
        <tr><td>ASIC Degradation (annual)</td><td>${state.degradation.toFixed(1)}%</td></tr>
        <tr><td>Uptime</td><td>${state.uptime.toFixed(1)}%</td></tr>
        <tr><td>All-in Fees</td><td>${(state.poolFee + state.hostingFee + state.managementFee + state.insuranceFee + state.repairReserve).toFixed(2)}%</td></tr>
      </tbody>
    </table>

    <div class="footer">
      <div class="footer-risks">
        <strong style="color:var(--gold)">Risk Factors:</strong> Bitcoin price volatility ¬∑ Network difficulty changes ¬∑ Downtime and hardware failure ¬∑ Hosting/power counterparty risk ¬∑ Regulatory and tax uncertainty
      </div>
      <div class="footer-disclaimer">
        This is a simplified, pre-tax model for illustrative purposes only. Past performance does not guarantee future results. All projections are scenario-based estimates and should not be construed as investment advice. ¬© ${new Date().getFullYear()} Pantheon Mining
      </div>
    </div>
  </div>
</body></html>`;
}

function loadFromUrl() {
  const params = new URLSearchParams(location.search);
  if (params.size === 0) return;
  params.forEach((v, k) => {
    if (k in DEFAULTS) {
      if (typeof DEFAULTS[k] === 'boolean') state[k] = v === 'true' || v === '1';
      else if (typeof DEFAULTS[k] === 'number') state[k] = +v;
      else state[k] = v;
    }
  });
}

async function init() {
  loadFromUrl();
  applyStateToUI();
  bindEvents();
  // Fetch BTC price and network hashrate in parallel
  await Promise.all([fetchBtcPrice(), fetchNetworkHashrate()]);
  updateAll();
}

init();
</script>
</body>
</html>
